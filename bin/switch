#!/usr/bin/env sh

DIR="${HOME}/nixos-config"


_nix_build() {
    echo "Building initial flake $1"
    nix --verbose --show-trace --extra-experimental-features "nix-command flakes" build "${DIR}/#$1"
}

# Wrapper for nixos-rebuild, darwin-rebuild, and home-manager which all
# expose the "switch" subcommand.
_switch() {
    cmd="$1"
    if [ -z "$2" ]; then
        attr="$DIR"
    else
        attr="$DIR/#$2"
    fi
    "${cmd}" --show-trace --verbose switch --flake "${attr}"
}

# rebuild the system configuration.
switch_system() {
    target="$1"
    if [ "$(uname -s)" = "Darwin" ]; then
        cmd="darwin-rebuild"
        if ! command -v "${cmd}" 1> /dev/null; then
            cd "${DIR}" || exit 1
            echo "Did not detect darwin-rebuild command."
            _nix_build "darwinConfigurations.${target}.system"
            cmd="${DIR}/result/sw/bin/darwin-rebuild"
        fi
    else
        cmd="nixos-rebuild"
    fi

    _switch "${cmd}" "${target}"
    return 0
}

# rebuild the home-manager configuration
switch_home() {
    target="$1"
    if [ -z "${target}" ]; then
        target="$(whoami)"
    fi

    if ! command -v "home-manager" 1> /dev/null; then
        cd "${DIR}" || exit 1
        echo "Building home manager configuration."
        _nix_build "homeConfigurations.${target}.activationPackage"
        ./result/activate
        echo "Restart shell to ensure changes."
    else
        _switch "home-manager" "${target}"
    fi

    return 0
}


case "$1" in
    --system|-s)
        switch_system "$2"
        ;;
    -h|--home)
        switch_home "$2"
        ;;
    --help)
        echo "Usage: switch [-h | -s] <flake attribute>."
        echo "Example: switch -h wmbp2022"
        exit 0
        ;;
    *)
        switch_home "$1"
        ;;
esac
exit 0
